window.ChatWidget = undefined;
"use strict";var ChatWidgetModule=(()=>{var z=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var xe=Object.prototype.hasOwnProperty;var Ne=(g,a)=>{for(var c in a)z(g,c,{get:a[c],enumerable:!0})},Se=(g,a,c,f)=>{if(a&&typeof a=="object"||typeof a=="function")for(let l of ve(a))!xe.call(g,l)&&l!==c&&z(g,l,{get:()=>a[l],enumerable:!(f=ke(a,l))||f.enumerable});return g};var Te=g=>Se(z({},"__esModule",{value:!0}),g);var Re={};Ne(Re,{default:()=>je});function Ce(){return new Promise((g,a)=>{let c=0,f=100,l=()=>{c++,console.log("Checking dependencies...",{react:!!window.React,reactDom:!!window.ReactDOM,pusher:!!window.Pusher}),window.React&&window.ReactDOM&&window.Pusher?g():c>=f?a(new Error("Dependencies failed to load")):setTimeout(l,100)};l()})}async function Le(g){let{websiteId:a,pusherKey:c,pusherCluster:f,baseUrl:l}=g;if(!a)throw new Error("Website ID is required");if(!c||!f)throw new Error("Pusher configuration is required");if(!l)throw new Error("Base URL is required");if(console.log("Creating widget for website:",a),console.log("Using base URL:",l),!document.querySelector('link[href*="/widget.css"]')){let o=document.createElement("link");o.rel="stylesheet",o.href=`${l}/widget.css`,document.head.appendChild(o),console.log("Added widget CSS from:",o.href)}let S=()=>{let o=new Audio(`${l}/notification.mp3`);return o.volume=.5,o},t=window.React,{useState:u,useEffect:h,useRef:w}=t,ee=window.ReactDOM,te=window.Pusher,b={async get(o,y={}){try{let s=new URLSearchParams(y).toString(),p=`${l}${o}${s?`?${s}`:""}`,k=await fetch(p,{headers:{"Content-Type":"application/json"},mode:"cors"});if(!k.ok)throw new Error(`API Error: ${k.statusText}`);return k.json()}catch(s){throw new Error(s instanceof Error?s.message:"Unknown error occurred")}},async post(o,y){try{let s=await fetch(`${l}${o}`,{method:"POST",headers:{"Content-Type":"application/json"},mode:"cors",body:JSON.stringify(y)});if(!s.ok)throw new Error(`API Error: ${s.statusText}`);return s.json()}catch(s){throw new Error(s instanceof Error?s.message:"Unknown error occurred")}},async upload(o,y){try{let s=await fetch(`${l}${o}`,{method:"POST",mode:"cors",body:y});if(!s.ok)throw new Error(`API Error: ${s.statusText}`);return s.json()}catch(s){throw new Error(s instanceof Error?s.message:"Unknown error occurred")}}};function ne({websiteId:o,pusherKey:y,pusherCluster:s}){let[p,k]=u(!1),[d,$]=u([]),[x,j]=u(""),[re,U]=u(!1),[O,N]=u(null),[oe,V]=u(!1),[se,_]=u(!1),[ae,q]=u(!1),[T,ie]=u(!0),[R,I]=u(!1),[le,F]=u(!1),[ce,ue]=u(!1),[C,D]=u(0),[K,de]=u(null),B=w(0),P=w(null),L=w(null),J=w(null),E=w(null),W=w(null),Y=w(null),A=w(null),G=w(null);h(()=>{let e=n=>{if(p){if(n.key==="Escape"){k(!1);return}if((n.ctrlKey||n.metaKey)&&n.key==="Enter"){x.trim()&&X(new Event("submit"));return}if(n.key==="PageUp"||n.key==="PageDown"){let r=L.current;if(!r)return;let i=r.clientHeight*.8;r.scrollBy({top:n.key==="PageUp"?-i:i,behavior:"smooth"}),n.preventDefault()}n.altKey&&n.key.toLowerCase()==="n"&&(J.current?.focus(),n.preventDefault())}};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[p,x]),h(()=>{let e=d[d.length-1];e?.id!==K&&de(e?.id)},[d]),h(()=>{let e=n=>{R&&A.current&&!A.current.contains(n.target)&&!Y.current.contains(n.target)&&I(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[R]),h(()=>{let e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js",e.async=!0,document.body.appendChild(e);let n=document.createElement("link");return n.rel="stylesheet",n.href="https://cdn.jsdelivr.net/npm/emoji-mart@latest/css/emoji-mart.css",document.head.appendChild(n),()=>{document.body.removeChild(e),document.head.removeChild(n)}},[]);let me=e=>{j(n=>n+e.native),I(!1)};h(()=>{W.current=S()},[]);let[m]=u(()=>{let e=localStorage.getItem(`chat_visitor_${o}`);if(e)return e;let n=Math.random().toString(36).substring(7);return localStorage.setItem(`chat_visitor_${o}`,n),n});h(()=>{if(console.log("Setting up Pusher subscription with:",{pusherKey:y,pusherCluster:s,websiteId:o,visitorId:m}),!y||!s||!o||!m){console.error("Missing required configuration for Pusher");return}try{let e=new te(y,{cluster:s});console.log("Pusher initialized successfully");let n=e.subscribe(`chat-${o}`);return console.log("Subscribing to channel:",`chat-${o}`),n.bind("pusher:subscription_succeeded",()=>{console.log("Successfully subscribed to channel:",`chat-${o}`)}),n.bind("pusher:subscription_error",r=>{console.error("Subscription error:",r)}),n.bind("message",r=>{console.log("Received message:",r),$(i=>i.some(v=>v.id===r.id)?i:r.senderType==="USER"||r.visitorId===m?(r.senderType==="USER"&&(V(!0),T&&W.current&&W.current.play().catch(console.error)),[...i,r]):i)}),n.bind("typing",r=>{console.log("Received typing event:",r),r.visitorId==="agent"&&(q(r.isTyping),r.isTyping&&(E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{q(!1)},3e3)))}),()=>{console.log("Cleaning up Pusher subscription"),E.current&&clearTimeout(E.current),n.unbind_all(),e.unsubscribe(`chat-${o}`),e.disconnect()}}catch(e){console.error("Error setting up Pusher:",e)}},[o,m,y,s,T]);let Q=(e=!1)=>{P.current&&(e?P.current.scrollIntoView({behavior:"auto"}):P.current.scrollIntoView({behavior:"smooth"}))};h(()=>{let e=L.current;if(!e)return;let n=()=>{let{scrollTop:r,scrollHeight:i,clientHeight:v}=e,Z=i-r-v<100;if(ue(!Z),Z)D(0),B.current=d.length;else{let Ee=d.slice(B.current).filter(be=>be.senderType==="USER").length;D(Ee)}};return e.addEventListener("scroll",n),()=>e.removeEventListener("scroll",n)},[d]),h(()=>{let e=L.current;if(!e)return;let{scrollTop:n,scrollHeight:r,clientHeight:i}=e;r-n-i<100&&(D(0),B.current=d.length)},[d]),h(()=>{let e=L.current;if(!e)return;let{scrollTop:n,scrollHeight:r,clientHeight:i}=e;r-n-i<100&&Q()},[d]),h(()=>{p&&V(!1)},[p]),h(()=>{if(p&&d.length>0){let e=d.filter(n=>n.senderType==="USER"&&!n.readAt);e.length>0&&b.post("/api/widget/messages/read",{websiteId:o,visitorId:m,messageIds:e.map(n=>n.id)})}},[p,d,o,m]),h(()=>{p&&(U(!0),N(null),b.get("/api/widget/messages",{websiteId:o,visitorId:m}).then(e=>{console.log("Loaded messages:",e),$(e),U(!1)}).catch(e=>{console.error("Error loading messages:",e),N("Failed to load messages. Please try again."),U(!1)}))},[p,o,m]);let ge=()=>{E.current&&clearTimeout(E.current),se||(_(!0),b.post("/api/widget/typing",{websiteId:o,visitorId:m,isTyping:!0}).catch(e=>console.error("Error sending typing event:",e))),E.current=setTimeout(()=>{_(!1),b.post("/api/widget/typing",{websiteId:o,visitorId:m,isTyping:!1}).catch(console.error)},2e3)},X=async e=>{if(e.preventDefault(),!x.trim())return;let n=x;j(""),N(null);try{let r=await b.post("/api/widget/messages",{content:n,websiteId:o,visitorId:m})}catch(r){console.error("Error sending message:",r),N("Failed to send message. Please try again."),j(n)}},he=async e=>{if(!e)return;F(!0),N(null);let n=new FormData;n.append("file",e),n.append("websiteId",o),n.append("visitorId",m);try{let r=await b.upload("/api/widget/upload",n),i=await b.post("/api/widget/messages",{content:"",websiteId:o,visitorId:m,attachment:r});$(v=>[...v,i])}catch(r){console.error("Error uploading file:",r),N(r.message||"Failed to upload file")}finally{F(!1)}},pe=({message:e})=>{if(e.attachment){let{contentType:n,url:r,filename:i}=e.attachment;return n.startsWith("image/")?t.createElement("div",{className:"space-y-2"},[t.createElement("img",{key:"image",src:r,alt:i,className:"max-w-full rounded",style:{maxHeight:"200px"}}),t.createElement("div",{key:"filename",className:"text-xs opacity-75"},i)]):t.createElement("a",{href:r,target:"_blank",rel:"noopener noreferrer",className:"flex items-center space-x-2 hover:opacity-75"},[t.createElement("svg",{key:"icon",className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})),t.createElement("span",{key:"filename",className:"truncate max-w-[200px]"},i)])}return t.createElement("div",{className:"break-words"},e.content)},fe=({message:e})=>e.senderType!=="VISITOR"?null:t.createElement("div",{className:"text-xs text-right mt-1"},e.readAt?t.createElement("span",{className:"text-blue-400",title:`Read at ${new Date(e.readAt).toLocaleTimeString()}`},"\u2713\u2713"):t.createElement("span",{className:"text-gray-400",title:"Sent"},"\u2713")),ye=()=>ce?t.createElement("button",{key:"scroll-button",onClick:()=>Q(!0),className:"absolute bottom-4 right-4 bg-blue-500 text-white p-2 rounded-full shadow-lg hover:bg-blue-600 transition-colors flex items-center space-x-1",title:C>0?`${C} new message${C===1?"":"s"}`:"Scroll to bottom"},[C>0&&t.createElement("span",{key:"count",className:"text-xs font-medium bg-red-500 px-1.5 py-0.5 rounded-full"},C),t.createElement("svg",{key:"icon",className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 14l-7 7m0 0l-7-7m7 7V3"}))]):null,we=({message:e,children:n})=>{let r=e.id===K,i=`max-w-[70%] rounded-lg p-3 ${e.senderType==="VISITOR"?"bg-blue-500 text-white":"bg-gray-100"} ${r?"animate-message-appear":""}`;return t.createElement("div",{className:i},n)};return t.createElement("div",{className:"fixed bottom-4 right-4 z-50"},p?t.createElement("div",{className:"bg-white rounded-lg shadow-xl w-96 flex flex-col",style:{height:"500px"}},[t.createElement("div",{key:"header",className:"p-4 border-b bg-blue-500 text-white rounded-t-lg flex justify-between items-center shrink-0"},[t.createElement("h3",{key:"title",className:"font-medium flex items-center space-x-2"},[t.createElement("span",{key:"text"},"Chat Support"),t.createElement("button",{key:"sound",onClick:()=>ie(!T),className:"ml-2 p-1 hover:bg-blue-600 rounded transition-colors",title:T?"Mute notifications":"Unmute notifications"},t.createElement("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},T?t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M6.5 8.788l-1.79-1.789a1 1 0 00-1.414 1.414l1.789 1.79-1.79 1.788a1 1 0 001.415 1.414l1.789-1.789 1.788 1.789a1 1 0 001.414-1.414L8.914 10.2l1.789-1.789a1 1 0 00-1.414-1.414L7.5 8.786 6.5 7.786v1.002z"}):t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"})))]),t.createElement("button",{key:"close",onClick:()=>k(!1),className:"text-white hover:text-gray-200"},t.createElement("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})))]),t.createElement("div",{key:"messages",ref:L,className:"flex-1 overflow-y-auto relative",style:{minHeight:0}},t.createElement("div",{className:"p-4 space-y-4"},[re&&t.createElement("div",{key:"loading",className:"flex justify-center items-center py-4"},t.createElement("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})),O&&t.createElement("div",{key:"error",className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"},O),...d.map(e=>t.createElement("div",{key:e.id,className:`flex flex-col ${e.senderType==="VISITOR"?"items-end":"items-start"}`},[t.createElement(we,{message:e},[t.createElement("div",{key:"header",className:"text-xs opacity-75 mb-1"},`${e.senderType==="USER"?"Agent":"You"} \u2022 ${new Date(e.createdAt).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}`),t.createElement(pe,{key:"content",message:e})]),t.createElement(fe,{key:"status",message:e})])),ae&&t.createElement("div",{key:"agent-typing",className:"flex justify-start"},t.createElement("div",{className:"bg-gray-100 rounded-lg p-3 flex items-center space-x-2"},[t.createElement("div",{className:"flex space-x-1"},[t.createElement("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),t.createElement("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),t.createElement("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]),t.createElement("span",{className:"text-sm text-gray-500"},"Agent is typing...")])),t.createElement("div",{key:"scroll-anchor",ref:P})]),t.createElement(ye)),t.createElement("form",{key:"form",onSubmit:X,className:"p-4 border-t relative shrink-0"},[t.createElement("div",{className:"flex space-x-2"},[t.createElement("button",{key:"emoji",type:"button",ref:Y,onClick:()=>I(!R),className:"p-2 text-gray-500 hover:text-gray-700 focus:outline-none"},t.createElement("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}))),t.createElement("button",{key:"attachment",type:"button",onClick:()=>G.current?.click(),disabled:le,className:"p-2 text-gray-500 hover:text-gray-700 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed",title:"Attach file"},t.createElement("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"}))),t.createElement("input",{key:"input",ref:J,type:"text",value:x,onChange:e=>{j(e.target.value),ge()},placeholder:"Type a message... (Ctrl+Enter to send)",className:"flex-1 rounded-lg border p-2 focus:outline-none focus:border-blue-500"}),t.createElement("button",{key:"submit",type:"submit",disabled:!x.trim(),className:"bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"},"Send")]),R&&t.createElement("div",{key:"emoji-picker",ref:A,className:"absolute bottom-full mb-2",style:{zIndex:1e3}},t.createElement("emoji-picker",{onEmojiSelect:e=>me(e)})),t.createElement("input",{key:"file-input",ref:G,type:"file",className:"hidden",onChange:e=>{let n=e.target.files?.[0];n&&(he(n),e.target.value="")},accept:".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt"})])]):t.createElement("button",{onClick:()=>k(!0),className:"relative bg-blue-500 text-white p-4 rounded-full shadow-lg hover:bg-blue-600 transition-colors"},[t.createElement("svg",{key:"icon",className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-4l-4 4z"})),oe&&t.createElement("div",{key:"unread",className:"absolute -top-1 -right-1 bg-red-500 rounded-full w-3 h-3"})]))}let M=document.createElement("div");return M.id="chat-widget-container",document.body.appendChild(M),ee.render(t.createElement(ne,{websiteId:a,pusherKey:c,pusherCluster:f}),M),console.log("Widget created successfully"),M}var H=class{constructor(){this.isInitialized=!1}async init(a){try{if(!a)throw new Error("Widget: Configuration is required");if(this.isInitialized){console.log("Chat widget already initialized");return}console.log("Initializing chat widget with config:",a);let c=a.websiteId,f=a.baseUrl||window.location.origin,l=a.pusherKey,S=a.pusherCluster;if(!c)throw new Error("Widget: Missing website ID");if(!l||!S)throw new Error("Widget: Missing Pusher configuration");console.log("Using configuration:",{websiteId:c,baseUrl:f,pusherKey:l,pusherCluster:S}),await Ce(),console.log("Dependencies loaded successfully"),await Le({websiteId:c,baseUrl:f,pusherKey:l,pusherCluster:S}),console.log("Widget created successfully"),this.isInitialized=!0}catch(c){throw console.error("Widget initialization error:",c),c}}},Me=new H,je=Me;return Te(Re);})();
window.ChatWidget = ChatWidgetModule.default;
